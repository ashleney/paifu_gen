<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>paifu_gen</title>
</head>

<body>
    <div style="width: 640px; height: 640px; overflow: hidden;">
        <iframe id="log-viewer-frame" src='' width="1265" height="1265" scrolling="no"
            style="transform: scale(0.5); transform-origin: 0 0; border: 20;"></iframe>
    </div>
    <section>
        <div id="inputs">
            <div>
                <input id="kyoku" placeholder="kyoku (S2)" />
                <input id="jikaze" placeholder="jikaze (N)" />
                <input id="kyotaku" placeholder="kyotaku (2)" />
                <input id="honba" placeholder="honba (3)" />
            </div>
            <div>
                <input id="dora" placeholder="dora (3m7z)" />
            </div>
            <div>
                <input id="score-hero" placeholder="score-hero (25000)" />
                <input id="score-shimocha" placeholder="score-shimocha (25000)" />
                <input id="score-toimen" placeholder="score-toimen (25000)" />
                <input id="score-kamicha" placeholder="score-kamicha (25000)" />
            </div>
            <div>
                <input id="tehai" placeholder="tehai (123m06799s333z)" style="width:420px" />
            </div>
            <div>
                <input id="kawa-hero" placeholder="kawa-hero (1m.9p0s-)" />
                <input id="kawa-shimocha" placeholder="kawa-shimocha (1m.9p0s-)" />
                <input id="kawa-toimen" placeholder="kawa-toimen (1m.9p0s-)" />
                <input id="kawa-kamicha" placeholder="kawa-kamicha (1m.9p0s-)" />
            </div>
            <div>
                <input id="fuuro-hero" placeholder="fuuro-hero ((2m)3m4m)" />
                <input id="fuuro-shimocha" placeholder="fuuro-shimocha (1z(1z)1z)" />
                <input id="fuuro-toimen" placeholder="fuuro-toimen (5z5z5z5z)" />
                <input id="fuuro-kamicha" placeholder="fuuro-kamicha (7z7z(7z)(7z))" />
            </div>
        </div>

        <textarea id="tenhou-json" style="width:100%; height:200px; resize:vertical; cursor:text"></textarea>

        <iframe id="tenhou-frame" class="tenhou" loading="lazy" scrolling="no" marginwidth="0" marginheight="0"
            frameborder="0" style="width:100%; height:600px;"></iframe>
    </section>

    <script type="module">
        import init, { generate_logs_js, generate_board_from_tenhou_js } from "./pkg/paifu_gen.js";

        async function run() {
            await init();

            function generate_board_from_tenhou() {
                const input_tenhou = JSON.parse(document.getElementById("tenhou-json").value)
                const board = generate_board_from_tenhou_js(input_tenhou, document.getElementById('jikaze').value || 'E');
                const setVal = (id, value) => document.getElementById(id).value = value;
                setVal("kyoku", board.kyoku);
                setVal("jikaze", board.jikaze);
                setVal("kyotaku", board.kyotaku);
                setVal("honba", board.honba);
                setVal("dora", board.dora);
                setVal("score-hero", board.scores[0]);
                setVal("score-shimocha", board.scores[1]);
                setVal("score-toimen", board.scores[2]);
                setVal("score-kamicha", board.scores[3]);
                setVal("tehai", board.tehai);
                setVal("kawa-hero", board.kawa[0]);
                setVal("kawa-shimocha", board.kawa[1]);
                setVal("kawa-toimen", board.kawa[2]);
                setVal("kawa-kamicha", board.kawa[3]);
                setVal("fuuro-hero", board.fuuro[0]);
                setVal("fuuro-shimocha", board.fuuro[1]);
                setVal("fuuro-toimen", board.fuuro[2]);
                setVal("fuuro-kamicha", board.fuuro[3]);
            }

            function generate_board() {
                const toVal = id => document.getElementById(id).value || "";
                const raw = {
                    kyoku: toVal('kyoku'),
                    jikaze: toVal('jikaze'),
                    kyotaku: toVal('kyotaku'),
                    honba: toVal('honba'),
                    dora: toVal('dora'),
                    scores: [
                        toVal('score-hero'),
                        toVal('score-shimocha'),
                        toVal('score-toimen'),
                        toVal('score-kamicha')
                    ],
                    tehai: toVal('tehai'),
                    kawa: [
                        toVal('kawa-hero'),
                        toVal('kawa-shimocha'),
                        toVal('kawa-toimen'),
                        toVal('kawa-kamicha')
                    ],
                    fuuro: [
                        toVal('fuuro-hero'),
                        toVal('fuuro-shimocha'),
                        toVal('fuuro-toimen'),
                        toVal('fuuro-kamicha')
                    ]
                };

                let generated;
                try {
                    generated = generate_logs_js(raw);
                } catch (err) {
                    document.getElementById('tenhou-json').value = 'Error: ' + err;
                    return;
                }

                const tenhouTextarea = document.getElementById('tenhou-json');
                tenhouTextarea.value = generated.tenhou_log || "";

                const log_iframe = document.getElementById("log-viewer-frame");
                const encoded_mjai = encodeURIComponent(JSON.stringify(generated.mjai_log));
                log_iframe.src = `./log-viewer/index.html?mjai_log=${encoded_mjai}&player_id=${generated.player_id}`;

                const tenhou_iframe = document.getElementById('tenhou-frame');
                const encoded_tenhou = encodeURIComponent(generated.tenhou_log);
                tenhou_iframe.src = `https://tenhou.net/5/?tw=${generated.player_id}&_=${Date.now()}#json=${encoded_tenhou}`;
            }

            document.getElementById('inputs').querySelectorAll('input').forEach(inp => {
                inp.addEventListener('input', generate_board);
            });

            const tenhouTextarea = document.getElementById('tenhou-json');
            tenhouTextarea.addEventListener('input', generate_board_from_tenhou);
            tenhouTextarea.addEventListener('blur', generate_board);

            generate_board();
        }

        run();
    </script>
</body>

</html>